<html>

<head>

    <meta charset="utf-8">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Answer</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href='https://fonts.googleapis.com/css?family=Darker Grotesque' rel='stylesheet'>
    <link type="text/css" rel="stylesheet" href="style.css"/>
</head>




<body>
    <center>
        <h2>Nội dung trả lời<h2>
    </center>

    <center>
        <input type="text" id="userId" placeholder="MSSV"></input><br>
        <textarea id="userInput" placeholder="Nhập câu trả lời..."></textarea><br>
        <span id="stt"> &nbsp </span><br>
        <button class="button-37" id="sentButton">Gửi <i class="fa fa-send"></i></button>
    </center>


    <h3>Danh sách câu trả lời:</h3>

    <div class="container" id = 'answerList'></div>

    <button id="rm" class="rm"></button>

</body>


<script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getFirestore, collection, doc, addDoc, getDocs, deleteDoc, serverTimestamp, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";


    const firebaseConfig = {
    apiKey: "AIzaSyAjIZdSKHn1ru_QEZJ1jvzQlVnziXgLbG8",
    authDomain: "answer-gdu.firebaseapp.com",
    projectId: "answer-gdu",
    storageBucket: "answer-gdu.firebasestorage.app",
    messagingSenderId: "804480278025",
    appId: "1:804480278025:web:30d3d01472168485c4a2d8",
    measurementId: "G-V3MQD3TXVQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);


    const userid = document.getElementById('userId');
    const text_input = document.getElementById('userInput');
    const sent_btn = document.getElementById('sentButton');
    const answer_list = document.getElementById('answerList');
    const stt = document.getElementById('stt');
    const rm = document.getElementById('rm');

    let count = 0;

    const ref = collection(db, 'answers');
    const q = query(ref, orderBy('timestamp'));
    onSnapshot(q, (snapshot) => {

      count = snapshot.size;
      answer_list.innerHTML = '';
      snapshot.forEach((doc) => {

        const answer = doc.data();
        const e = document.createElement('div');
        e.innerHTML = '<div class="box"><div class="label">'+answer.id+'</div>'+answer.text+'</div>';
        answer_list.prepend(e.firstChild);

      });
    });
    sent_btn.addEventListener('click', async (e) => {
      e.preventDefault();

      const mssv = userid.value.trim();
      const text = text_input.value.trim()

      if(count < 10){
        if (mssv.trim() && text.trim()) {
            text_input.value = '';
            stt.innerHTML = "Đã gửi câu trả lời!";
            sent_btn.disabled = true;
            await addDoc(ref, {
                id: mssv,
                text,
                timestamp: serverTimestamp(),
              });
          }
          else
            stt.innerHTML = "Nội dung không đầy đủ!";
      }else
        stt.innerHTML = "Đã quá số lượng nộp!";
    });


    let i = 0;
    rm.addEventListener('click', async (e) => {
      e.preventDefault();
      i++; 
      console.log(i);
      if(i % 5 == 0){
         const q = await getDocs(collection(db, 'answers'));
         for (const document of q.docs)
         await deleteDoc(doc(db, 'answers', document.id));
         sent_btn.disabled = false;
      }
    });
</script>
</html>
